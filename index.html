<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ramadhan Display Final | Purwokerto</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0f172a;
  --panel:#111827;
  --primary:#22d3ee;
  --accent:#fbbf24;
  --text:#f8fafc;
  --muted:#94a3b8;
  --active:#10b981;
}

*{box-sizing:border-box;font-family:'Inter',sans-serif}
html,body{width:100%;height:100%;}

body{
  margin:0;
  background:radial-gradient(circle at 30% 30%,#1e293b,var(--bg));
  color:var(--text);
  padding:20px;
  transition:.4s ease;
  position:relative;
  overflow-x:hidden;
}

body::before{
  content:"";
  position:fixed;
  inset:0;
  background-image:
    radial-gradient(circle at 25% 25%, rgba(255,255,255,0.03) 2px, transparent 2px),
    radial-gradient(circle at 75% 60%, rgba(255,255,255,0.03) 2px, transparent 2px);
  background-size:140px 140px;
  pointer-events:none;
}

/* ================= TV MODE ================= */

body.tv-mode{
  padding:0;
  overflow:hidden;
}

.wrapper{
  display:grid;
  grid-template-columns:1fr;
  gap:24px;
  max-width:1400px;
  margin:auto;
  min-height: 100vh;
  align-items: center;
}

body.tv-mode .wrapper{
  grid-template-columns: 45% 55%; 
  gap:0;
  max-width:100%;
}

.panel{
  background:var(--panel);
  border-radius:28px;
  padding:40px;
  box-shadow:0 20px 60px rgba(0,0,0,.5);
}

body.tv-mode .panel{
  border-radius:0;
  height:100vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.header-row{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  margin-bottom:30px;
}

.title{font-size:clamp(22px, 2.5vw, 32px); font-weight:800; line-height:1.2}

.big-date{
  font-size:clamp(18px, 1.8vw, 24px);
  font-weight:600;
  margin-top:10px;
  color:var(--accent);
}

.hijri{font-size:16px; color:var(--muted); margin-top:5px}
.small-clock{font-size:24px; font-weight:700; color:var(--primary); font-variant-numeric: tabular-nums;}

.tv-toggle{
  margin-top:15px;
  background:rgba(34,211,238,.15);
  color:var(--primary);
  border:1px solid var(--primary);
  padding:8px 16px;
  border-radius:999px;
  cursor:pointer;
  font-size:14px;
  font-weight:600;
}

.countdown-label{
  text-transform:uppercase;
  font-size:clamp(14px, 1.2vw, 18px);
  letter-spacing:4px;
  color:var(--muted);
}

.main-time{
  font-size:clamp(60px, 8vw, 120px);
  font-weight:800;
  letter-spacing:-2px;
  color:var(--primary);
  margin: 10px 0;
  font-variant-numeric: tabular-nums;
}

.active-indicator{
  margin-top:20px;
  padding: 10px 20px;
  background: rgba(16,185,129,0.1);
  display: inline-block;
  border-radius: 12px;
  font-size:clamp(16px, 1.5vw, 22px);
  font-weight:600;
  color:var(--active);
}

/* ================= TABLE ================= */

.table-wrapper{
  overflow:hidden;
  border-radius:20px;
  background: rgba(0,0,0,0.2);
}

body.tv-mode .table-wrapper {
  height: 90%;
  margin: 20px;
}

table{width:100%; border-collapse:collapse;}

th{
  background:#1f2937;
  padding:18px 10px;
  font-size: clamp(10px, 0.8vw, 14px);
  text-transform:uppercase;
  color:var(--muted);
}

td{
  padding:clamp(10px, 1.2vh, 18px) 10px;
  border-bottom:1px solid rgba(255,255,255,0.03);
  font-size: clamp(12px, 0.9vw, 15px);
  text-align: center;
}

/* Highlight Hari Ini */
tr.today {
  background: rgba(34, 211, 238, 0.2) !important;
  box-shadow: inset 6px 0 0 var(--primary);
}
tr.today td { font-weight: 700; color: var(--primary); }

tr.eid-day td:first-child{ color:var(--accent); font-weight:800; }

.fade{ animation:fadeSlide .6s ease; }
@keyframes fadeSlide{
  from{opacity:0; transform:translateX(20px);}
  to{opacity:1; transform:translateX(0);}
}

.overlay{
  position:fixed;
  inset:0;
  background:rgba(15, 23, 42, 0.98);
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  opacity:0;
  pointer-events:none;
  transition:.5s;
  z-index:999;
}
.overlay.show{opacity:1}
</style>
</head>
<body>

<div class="overlay" id="overlay">
  <h1 id="overlayTitle" style="font-size:8vw; color:var(--accent); margin:0;">ADZAN</h1>
  <p id="overlayName" style="font-size:4vw; color:white"></p>
</div>

<div class="wrapper">
  <div class="panel">
    <div class="header-row">
      <div>
        <div class="title">Jadwal Ramadhan<br>Purwokerto</div>
        <div class="big-date" id="bigDate"></div>
        <div class="hijri" id="hijriDate">Hijriyah</div>
      </div>
      <div style="text-align:right">
        <div class="small-clock" id="smallClock">00:00:00</div>
        <button class="tv-toggle" id="tvToggle">TV Mode</button>
      </div>
    </div>

    <div style="margin-top:auto; margin-bottom:auto">
      <div class="countdown-label" id="nextLabel">Waktu Sekarang</div>
      <div class="main-time" id="mainTime">--:--:--</div>
      <div class="active-indicator" id="activeIndicator">Data Aktif: -</div>
    </div>
  </div>

  <div class="panel">
    <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Tanggal</th>
          <th>Imsak</th>
          <th>Subuh</th>
          <th>Dzuhur</th>
          <th>Ashar</th>
          <th>Maghrib</th>
          <th>Isya</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    </div>
  </div>
</div>

<script>
/* ================= LOGIC ================= */
const tvToggle = document.getElementById('tvToggle');
tvToggle.addEventListener('click', () => {
  document.body.classList.toggle('tv-mode');
  if(document.body.classList.contains('tv-mode')) document.documentElement.requestFullscreen?.();
});

const lat=-7.4242, lon=109.2396, method=20, school=0;
let ramadhanData=[], todayPrayers=[], tablePage=0;

async function init(){
  const year=new Date().getFullYear();
  for(let m=2;m<=3;m++){
    const res=await fetch(`https://api.aladhan.com/v1/calendar?latitude=${lat}&longitude=${lon}&method=${method}&school=${school}&month=${m}&year=${year}`);
    const data=await res.json();
    if(data.code===200) data.data.forEach(d=>{
      const [dd, mm] = d.date.gregorian.date.split('-').map(Number);
      if(d.date.hijri.month.number === 9 || (mm === 3 && dd <= 21)) ramadhanData.push(d);
    });
  }
  renderTable(); 
  prepareToday();
  setInterval(changeTablePage, 25000); 
}

function renderTable(){
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  tbody.classList.add('fade');
  
  const now = new Date();
  // Hitung waktu 24 jam yang lalu (untuk menyertakan kemarin)
  const yesterdayLimit = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1).getTime();

  // FILTER: Ambil data mulai dari kemarin (T-1) sampai masa depan
  const activeData = ramadhanData.filter(d => {
    const [dd, mm, yyyy] = d.date.gregorian.date.split('-').map(Number);
    const itemDate = new Date(yyyy, mm - 1, dd).getTime();
    return itemDate >= yesterdayLimit;
  });

  const start = tablePage * 10;
  const slice = activeData.slice(start, start + 10);

  if (slice.length === 0 && tablePage > 0) {
    tablePage = 0;
    renderTable();
    return;
  }

  slice.forEach(d => {
    const tr = document.createElement('tr');
    const [dd, mm] = d.date.gregorian.date.split('-').map(Number);
    
    // Highlight Hanya Hari Ini
    if(dd === now.getDate() && mm === (now.getMonth() + 1)) {
        tr.classList.add('today');
    }

    let labelDate = d.date.readable.split(' ').slice(0, 2).join(' ');
    if(mm === 3 && (dd === 20 || dd === 21)) { 
      tr.classList.add('eid-day'); 
      labelDate += " (Eid)"; 
    }

    tr.innerHTML = `<td>${labelDate}</td><td>${clean(d.timings.Imsak)}</td><td>${clean(d.timings.Fajr)}</td><td>${clean(d.timings.Dhuhr)}</td><td>${clean(d.timings.Asr)}</td><td>${clean(d.timings.Maghrib)}</td><td>${clean(d.timings.Isha)}</td>`;
    tbody.appendChild(tr);
  });
  setTimeout(()=>tbody.classList.remove('fade'),600);
}

function changeTablePage(){
  const now = new Date();
  const yesterdayLimit = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1).getTime();
  
  const activeCount = ramadhanData.filter(d => {
    const [dd, mm, yyyy] = d.date.gregorian.date.split('-').map(Number);
    const itemDate = new Date(yyyy, mm - 1, dd).getTime();
    return itemDate >= yesterdayLimit;
  }).length;

  tablePage++;
  if(tablePage * 10 >= activeCount) tablePage = 0;
  renderTable();
}

function clean(t){return t.replace(/\s*\(.+\)/,'').trim();}

function prepareToday(){
  const now=new Date();
  document.getElementById('bigDate').textContent=now.toLocaleDateString('id-ID',{weekday:'long', day:'numeric', month:'long'});
  const today=ramadhanData.find(d=>{
    const [dd,mm]=d.date.gregorian.date.split('-').map(Number);
    return dd===now.getDate()&&mm===now.getMonth()+1;
  });
  if(!today) return;
  document.getElementById('hijriDate').textContent=`${today.date.hijri.day} ${today.date.hijri.month.en} ${today.date.hijri.year} H`;
  const [dd,mm,yyyy]=today.date.gregorian.date.split('-').map(Number);
  todayPrayers=[
    {name:'Imsak',time:clean(today.timings.Imsak)},
    {name:'Subuh',time:clean(today.timings.Fajr)},
    {name:'Dzuhur',time:clean(today.timings.Dhuhr)},
    {name:'Ashar',time:clean(today.timings.Asr)},
    {name:'Maghrib',time:clean(today.timings.Maghrib)},
    {name:'Isya',time:clean(today.timings.Isha)}
  ].map(p=>{
    const [h,m]=p.time.split(':').map(Number);
    return {...p,date:new Date(yyyy,mm-1,dd,h,m,0)};
  });
  setInterval(updateDisplay,1000);
}

function updateDisplay(){
  const now=new Date();
  const mainTime=document.getElementById('mainTime');
  const nextLabel=document.getElementById('nextLabel');
  document.getElementById('smallClock').textContent=formatClock(now);
  document.getElementById('activeIndicator').textContent = getStatusText(now);

  const next=todayPrayers.find(p=>p.date > now);
  const oneHour = 60 * 60 * 1000;

  if(next && (next.date - now > oneHour)){
    nextLabel.textContent = 'Waktu Sekarang';
    mainTime.textContent = formatClock(now);
    mainTime.style.color = "var(--text)";
  } 
  else if(next){
    nextLabel.textContent = 'Menuju ' + next.name;
    mainTime.textContent = format(next.date - now);
    mainTime.style.color = "var(--primary)";
    if(next.date-now <= 1000) triggerAdzan(next.name);
  } else {
    nextLabel.textContent = 'Waktu Sekarang';
    mainTime.textContent = formatClock(now);
  }
}

function getStatusText(now){
  const limit = 3 * 60 * 1000;
  for(let i=todayPrayers.length-1; i>=0; i--){
    const diff = now - todayPrayers[i].date;
    if(diff >= 0) return (diff > limit) ? 'Waktu aktif: -' : 'Waktu aktif: ' + todayPrayers[i].name;
  }
  return 'Waktu aktif: -';
}

function triggerAdzan(name){
  document.getElementById('overlayName').textContent=name;
  document.getElementById('overlay').classList.add('show');
  setTimeout(()=>document.getElementById('overlay').classList.remove('show'),15000);
}

function format(ms){
  const t=Math.floor(ms/1000);
  return`${String(Math.floor(t/3600)).padStart(2,'0')}:${String(Math.floor((t%3600)/60)).padStart(2,'0')}:${String(t%60).padStart(2,'0')}`;
}

function formatClock(d){
  return`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
}

init();
</script>
</body>
</html>