<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ramadhan Display Final | Purwokerto</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg-day: radial-gradient(circle at 30% 30%, #1e293b, #0f172a);
  --bg-night: radial-gradient(circle at 30% 30%, #020617, #0f172a);
  --panel: #111827;
  --primary: #22d3ee;
  --accent: #fbbf24;
  --text: #f8fafc;
  --muted: #94a3b8;
  --active: #10b981;
}

*{box-sizing:border-box;font-family:'Inter',sans-serif}
html,body{width:100%;height:100%;}

body{
  margin:0;
  background: var(--bg-day);
  color:var(--text);
  padding:20px;
  transition: background 2s ease;
  position:relative;
  overflow-x:hidden;
}

body.night-mode { background: var(--bg-night); }

body::before{
  content:"";
  position:fixed;
  inset:0;
  background-image:
    radial-gradient(circle at 25% 25%, rgba(255,255,255,0.03) 2px, transparent 2px),
    radial-gradient(circle at 75% 60%, rgba(255,255,255,0.03) 2px, transparent 2px);
  background-size:140px 140px;
  pointer-events:none;
}

/* ================= TV MODE ================= */
body.tv-mode{ padding:0; overflow:hidden; }
.wrapper{
  display:grid;
  grid-template-columns:1fr;
  gap:24px;
  max-width:1400px;
  margin:auto;
  min-height: 100vh;
  align-items: center;
}
body.tv-mode .wrapper{ grid-template-columns: 45% 55%; gap:0; max-width:100%; }

.panel{
  background:var(--panel);
  border-radius:28px;
  padding:40px;
  box-shadow:0 20px 60px rgba(0,0,0,.5);
}
body.tv-mode .panel{ border-radius:0; height:100vh; display: flex; flex-direction: column; justify-content: center; }

.header-row{ display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:30px; }
.title{font-size:clamp(22px, 2.5vw, 32px); font-weight:800; line-height:1.2}
.big-date{ font-size:clamp(18px, 1.8vw, 24px); font-weight:600; margin-top:10px; color:var(--accent); }
.hijri{font-size:16px; color:var(--muted); margin-top:5px}
.small-clock{font-size:24px; font-weight:700; color:var(--primary); font-variant-numeric: tabular-nums;}

.tv-toggle{
  margin-top:15px;
  background:rgba(34,211,238,.15);
  color:var(--primary);
  border:1px solid var(--primary);
  padding:8px 16px;
  border-radius:999px;
  cursor:pointer;
  font-size:14px;
  font-weight:600;
}

.next-box {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  padding: 12px 20px;
  display: inline-flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 20px;
}
.next-box .label { color: var(--muted); font-size: 14px; text-transform: uppercase; font-weight: 600; letter-spacing: 1px; }
.next-box .val { color: var(--accent); font-size: 20px; font-weight: 800; }

.countdown-label{ text-transform:uppercase; font-size:clamp(14px, 1.2vw, 18px); letter-spacing:4px; color:var(--muted); }
.main-time{
  font-size:clamp(60px, 8vw, 120px);
  font-weight:800;
  letter-spacing:-2px;
  color:var(--primary);
  margin: 10px 0;
  font-variant-numeric: tabular-nums;
}
.active-indicator{
  margin-top:20px;
  padding: 10px 20px;
  background: rgba(16,185,129,0.1);
  display: inline-block;
  border-radius: 12px;
  font-size:clamp(16px, 1.5vw, 22px);
  font-weight:600;
  color:var(--active);
}

/* ================= TABLE ================= */
.table-wrapper{ overflow:hidden; border-radius:20px; background: rgba(0,0,0,0.2); }
body.tv-mode .table-wrapper { height: 90%; margin: 20px; }
table{width:100%; border-collapse:collapse;}
th{ background:#1f2937; padding:18px 10px; font-size: clamp(10px, 0.8vw, 14px); text-transform:uppercase; color:var(--muted); }
td{ padding:clamp(10px, 1.2vh, 18px) 10px; border-bottom:1px solid rgba(255,255,255,0.03); font-size: clamp(12px, 0.9vw, 15px); text-align: center; }

tr.today { background: rgba(34, 211, 238, 0.2) !important; box-shadow: inset 6px 0 0 var(--primary); }
tr.today td { font-weight: 700; color: var(--primary); }

.overlay{
  position:fixed; inset:0; background:rgba(15, 23, 42, 0.98);
  display:flex; align-items:center; justify-content:center; flex-direction:column;
  opacity:0; pointer-events:none; transition:.5s; z-index:999;
}
.overlay.show{opacity:1}
</style>
</head>
<body>

<div class="overlay" id="overlay">
  <p id="overlayHeader" style="font-size:1.5vw; color:var(--text); opacity:0.6; margin:0; text-transform: uppercase; font-weight: 400; letter-spacing: 12px;"></p>
  <h1 id="overlayMain" style="font-size:7.5vw; color:var(--accent); font-weight: 800; margin: 10px 0; text-transform: uppercase; letter-spacing: -2px;"></h1>
  <div style="width: 100px; height: 4px; background: var(--primary); margin: 20px 0;"></div>
  <p id="overlaySub" style="font-size:2vw; color:var(--text); font-weight: 400; font-style: italic; opacity: 0.9;"></p>
</div>

<div class="wrapper">
  <div class="panel">
    <div class="header-row">
      <div>
        <div class="title" id="locTitle">Jadwal Imsakiyah<br>Purwokerto</div>
        <div class="big-date" id="bigDate">Memuat...</div>
        <div class="hijri" id="hijriDate"></div>
      </div>
      <div style="text-align:right">
        <div class="small-clock" id="smallClock">00:00:00</div>
        <button class="tv-toggle" id="tvToggle">TV Mode</button>
      </div>
    </div>

    <div style="margin-top:auto; margin-bottom:auto">
      <div class="next-box" id="nextBox" style="display: none;">
        <span class="label" id="nextBoxLabel">Jadwal Berikutnya</span>
        <span class="val" id="nextBoxTime">--:--</span>
      </div>

      <div class="countdown-label" id="nextLabel">Waktu Sekarang</div>
      <div class="main-time" id="mainTime">--:--:--</div>
      <div id="activeIndicator" class="active-indicator">Waktu aktif: -</div>
    </div>
  </div>

  <div class="panel">
    <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Tgl</th>
          <th>Imsak</th>
          <th>Subuh</th>
          <th>Dzuhur</th>
          <th>Ashar</th>
          <th>Maghrib</th>
          <th>Isya</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    </div>
  </div>
</div>

<script>
let imsakiyahData = [];
let tablePage = 0;
let isUsingAPI = false;

async function loadData() {
  const now = new Date();
  const limitDate = new Date(2026, 2, 20, 23, 59, 59);

  if (now > limitDate) {
    isUsingAPI = true;
    // Otomatis ubah judul ke Jadwal Sholat
    document.getElementById('locTitle').innerHTML = "Jadwal Sholat<br>Purwokerto";
    await loadFromAPI();
  } else {
    try {
      const response = await fetch('imsakiyah.json');
      const json = await response.json();
      imsakiyahData = json.data;
      // Judul Ramadhan
      document.getElementById('locTitle').innerHTML = "Jadwal Imsakiyah<br>Purwokerto";
      init();
    } catch (e) {
      await loadFromAPI();
    }
  }
}

async function loadFromAPI() {
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth() + 1;
  const url = `https://api.aladhan.com/v1/calendar?latitude=-7.4244&longitude=109.2302&method=11&month=${month}&year=${year}`;

  try {
    const res = await fetch(url);
    const json = await res.json();
    imsakiyahData = json.data.map(item => {
      return {
        tgl: `${item.date.gregorian.day} ${item.date.gregorian.month.en.substring(0,3)}`,
        ramadhan: item.date.hijri.day,
        imsak: item.timings.Imsak.split(' ')[0],
        subuh: item.timings.Fajr.split(' ')[0],
        dzuhur: item.timings.Dhuhr.split(' ')[0],
        ashar: item.timings.Asr.split(' ')[0],
        maghrib: item.timings.Maghrib.split(' ')[0],
        isya: item.timings.Isha.split(' ')[0],
        hijriFormatted: `${item.date.hijri.day} ${item.date.hijri.month.en} ${item.date.hijri.year}`
      };
    });
    init();
  } catch (err) { console.error(err); }
}

function init(){
  updateEngine();
  setInterval(updateEngine, 1000);
  setInterval(() => { tablePage++; renderTable(); }, 15000);
}

function updateEngine(){
  const now = new Date();
  document.getElementById('smallClock').textContent = formatClock(now);
  document.getElementById('bigDate').textContent = now.toLocaleDateString('id-ID',{weekday:'long', day:'numeric', month:'long'});
  
  renderTable();
  handleCountdown(now);
  updateBackgroundMode(now);
}

function getSysDateStr(dateObj) {
    const months = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Agu", "Sep", "Okt", "Nov", "Des"];
    return `${String(dateObj.getDate()).padStart(2, '0')} ${months[dateObj.getMonth()]}`;
}

function renderTable(){
  const tbody = document.getElementById('tbody');
  const now = new Date();
  const todayStr = getSysDateStr(now);
  
  const yesterday = new Date(now);
  yesterday.setDate(now.getDate() - 1);
  const yesterdayStr = getSysDateStr(yesterday);

  const activeData = imsakiyahData.filter(d => {
      const idxToday = imsakiyahData.findIndex(item => item.tgl === todayStr);
      const idxYest = imsakiyahData.findIndex(item => item.tgl === yesterdayStr);
      const startIdx = idxYest !== -1 ? idxYest : (idxToday !== -1 ? idxToday : 0);
      return imsakiyahData.indexOf(d) >= startIdx;
  });

  const maxPages = Math.ceil(activeData.length / 10);
  if (tablePage >= maxPages) tablePage = 0;
  const slice = activeData.slice(tablePage * 10, (tablePage * 10) + 10);
  
  tbody.innerHTML = '';
  slice.forEach(d => {
    const tr = document.createElement('tr');
    if(d.tgl === todayStr) tr.classList.add('today');
    tr.innerHTML = `<td>${d.tgl}</td><td>${d.imsak}</td><td>${d.subuh}</td><td>${d.dzuhur}</td><td>${d.ashar}</td><td>${d.maghrib}</td><td>${d.isya}</td>`;
    tbody.appendChild(tr);
  });
}

function handleCountdown(now){
  const todayStr = getSysDateStr(now);
  const dToday = imsakiyahData.find(d => d.tgl === todayStr);
  if(!dToday) return;

  if(isUsingAPI) document.getElementById('hijriDate').textContent = dToday.hijriFormatted;
  else document.getElementById('hijriDate').textContent = `${dToday.ramadhan} Ramadhan 1447 H`;

  const prayers = [
    {name:'Imsak', time: parseT(dToday.tgl, dToday.imsak), raw: dToday.imsak},
    {name:'Subuh', time: parseT(dToday.tgl, dToday.subuh), raw: dToday.subuh},
    {name:'Dzuhur', time: parseT(dToday.tgl, dToday.dzuhur), raw: dToday.dzuhur},
    {name:'Ashar', time: parseT(dToday.tgl, dToday.ashar), raw: dToday.ashar},
    {name:'Maghrib', time: parseT(dToday.tgl, dToday.maghrib), raw: dToday.maghrib},
    {name:'Isya', time: parseT(dToday.tgl, dToday.isya), raw: dToday.isya}
  ];

  document.getElementById('activeIndicator').textContent = getStatusText(now, prayers);

  let nextInToday = prayers.find(p => p.time > now);

  const mainTime = document.getElementById('mainTime');
  const nextLabel = document.getElementById('nextLabel');
  const nextBox = document.getElementById('nextBox');
  const nextBoxLabel = document.getElementById('nextBoxLabel');
  const nextBoxTime = document.getElementById('nextBoxTime');

  if(nextInToday){
    nextBox.style.display = 'inline-flex';
    nextBoxLabel.textContent = nextInToday.name;
    nextBoxTime.textContent = nextInToday.raw;

    const diff = nextInToday.time - now;
    if(diff > 3600000){
      nextLabel.textContent = 'Waktu Sekarang';
      mainTime.textContent = formatClock(now);
      mainTime.style.color = "var(--text)";
    } else {
      nextLabel.textContent = 'Menuju ' + nextInToday.name;
      mainTime.textContent = formatDiff(diff);
      mainTime.style.color = "var(--primary)";
      if(diff <= 1000 && diff > 0) triggerAdzan(nextInToday.name);
    }
  } else {
    nextBox.style.display = 'none';
    nextLabel.textContent = 'Waktu Sekarang';
    mainTime.textContent = formatClock(now);
    mainTime.style.color = "var(--text)";
  }
}

function parseT(tglStr, timeHM){
  const [d, mStr] = tglStr.split(' ');
  const months = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Agu", "Sep", "Okt", "Nov", "Des"];
  const m = months.indexOf(mStr);
  const [hh, mm] = timeHM.split(':').map(Number);
  const now = new Date();
  return new Date(now.getFullYear(), m, parseInt(d), hh, mm, 0);
}
function formatClock(d){ return`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`; }
function formatDiff(ms){
  const t=Math.floor(ms/1000);
  return`${String(Math.floor(t/3600)).padStart(2,'0')}:${String(Math.floor((t%3600)/60)).padStart(2,'0')}:${String(t%60).padStart(2,'0')}`;
}
function getStatusText(now, prayers){
  const limit = 300000;
  for(let i = prayers.length - 1; i >= 0; i--){
    const diff = now - prayers[i].time;
    if(diff >= 0) return (diff > limit) ? 'Waktu aktif: -' : 'Waktu aktif: ' + prayers[i].name;
  }
  return 'Waktu aktif: -';
}
function updateBackgroundMode(now) {
  const todayStr = getSysDateStr(now);
  const dToday = imsakiyahData.find(d => d.tgl === todayStr);
  if (!dToday) return;
  const subuh = parseT(dToday.tgl, dToday.subuh);
  const maghrib = parseT(dToday.tgl, dToday.maghrib);
  if (now >= subuh && now < maghrib) document.body.classList.remove('night-mode');
  else document.body.classList.add('night-mode');
}
function triggerAdzan(name){
  const overlayHeader = document.getElementById('overlayHeader');
  const overlayMain = document.getElementById('overlayMain');
  const overlaySub = document.getElementById('overlaySub');
  overlayHeader.textContent = "SAAT INI SUDAH";
  overlayMain.textContent = `MASUK WAKTU ${name}`;
  if (name === 'Imsak') overlaySub.textContent = "Waktunya bersiap untuk memulai puasa";
  else if (name === 'Subuh') overlaySub.textContent = "Selamat menjalankan ibadah puasa";
  else if (name === 'Maghrib') overlaySub.textContent = "Alhamdulillah, selamat berbuka puasa";
  else overlaySub.textContent = "Waktu untuk menunaikan ibadah";
  document.getElementById('overlay').classList.add('show');
  setTimeout(() => document.getElementById('overlay').classList.remove('show'), 15000);
}

document.getElementById('tvToggle').addEventListener('click', () => {
  document.body.classList.toggle('tv-mode');
  if(document.body.classList.contains('tv-mode')) document.documentElement.requestFullscreen?.();
});

loadData();
</script>
</body>
</html>